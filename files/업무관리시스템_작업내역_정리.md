# 업무관리시스템 작업 내역 정리

## 작업 일자: 2025-01-26

---

## 1. 모달 표시 안되는 문제 해결

### 문제
- CS관리, 바이어관리에서 목록 클릭 시 모달이 안 나옴
- `openCSDetail(0)` 호출 시 "데이터 없음" 에러

### 원인
Supabase에서 데이터 로드 시 기본 데이터(n8n 테스트 등)가 **덮어씌워짐**
```javascript
// 기존 - 덮어쓰기
csData = mapper.mapCSData(cs);

// 문제: id=0인 기본 테스트 데이터가 사라짐
```

### 해결
데이터 로드 시 기본 데이터 유지하면서 추가하도록 수정
```javascript
// 수정 후 - 기본 데이터 유지 + 새 데이터 추가
if (cs && cs.length > 0) {
  const newCSData = mapper.mapCSData(cs);
  const maxDefaultId = Math.max(...csData.map(c => c.id));
  newCSData.forEach((item, idx) => {
    item.id = maxDefaultId + 1 + idx;
  });
  csData = [...csData, ...newCSData];
}
```

### 수정 위치
- 파일: `업무관리시스템_통합_완성_공지_프로세스.html`
- 라인: 약 10282~10291

---

## 2. Supabase 저장 기능 추가

### 배경
모달에서 데이터 추가/수정해도 브라우저 메모리에만 저장되어 새로고침하면 사라짐

### 수정한 함수들

| 함수명 | 기능 | 수정 내용 |
|--------|------|----------|
| `saveCSDetailEdit(id)` | CS 상세 모달 저장 | `updateCSData()` 호출 추가 |
| `saveCSEdit(id)` | CS 수정 모드 저장 | `updateCSData()` 호출 추가 |
| `saveCSReply(id)` | CS 답변 저장 | `updateCSData()` 호출 추가 |
| `saveCSReplyAndRefresh(id)` | CS 답변 저장+새로고침 | `updateCSData()` 호출 추가 |

### 이미 Supabase 연동되어 있던 함수들
- `submitCSRegister()` - CS 신규 등록
- `saveBuyerEdit()` - 바이어 수정
- `submitBuyerRegister()` - 바이어 신규 등록
- `updateCSStatus()` - CS 상태 변경

### 수정 예시
```javascript
// 수정 전
function saveCSDetailEdit(id) {
  // 로컬 데이터만 업데이트
  item.title = document.getElementById('cs-detail-title').value;
  showToast('✅ 저장되었습니다');
}

// 수정 후
async function saveCSDetailEdit(id) {
  const supabaseUpdates = {
    title, priority, status, /* ... */
  };

  try {
    await updateCSData(id, supabaseUpdates);  // Supabase 저장
    // 로컬 데이터 업데이트
    showToast('✅ 저장되었습니다 (Supabase 동기화 완료)');
  } catch (error) {
    showToast('⚠️ 저장됨 (로컬만)');
  }
}
```

---

## 3. Hash 네비게이션 기능 추가

### 목적
발표자료에서 `#cs-management` 링크로 접속하면 자동으로 CS관리 탭 열기

### 추가 코드
```javascript
// URL hash로 탭 자동 전환
window.addEventListener('load', function() {
  if (window.location.hash === '#cs-management') {
    switchSubTab('cs');
  }
});
```

### 추가 위치
- 파일: `업무관리시스템_통합_완성_공지_프로세스.html`
- 위치: `</script>` 직전 (스크립트 마지막 부분)

### 사용법
```
업무관리시스템_통합_완성_공지_프로세스.html#cs-management
```

---

## 4. 모달 CSS 수정

### 수정 내용
```css
/* 모달 */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.2s ease;
  pointer-events: none;  /* 추가 */
}
.modal-overlay.show {
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;  /* 추가 */
}

/* 확장거래관리 모달 */
.modal-overlay.active {
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
}
```

---

## 5. 알리바바 연동 자동화 계획

### 자동화 가능 영역

| 영역 | 현재 | 자동화 후 |
|------|------|----------|
| CS 문의 | 이메일 n8n 연동 완료 | ✅ 완료 |
| 바이어 CRM | 수동 입력 | API로 자동 수집 예정 |
| 주문 동기화 | 수동 입력 | API로 자동 동기화 예정 |

### 바이어 CRM 자동 연동 방법

#### 필요 사항
1. 알리바바 판매자 계정
2. Open Platform API 키 발급
3. n8n 워크플로우 구성

#### 연동 흐름
```
알리바바 바이어 문의/주문
    ↓
Alibaba API (바이어 정보 조회)
    ↓
n8n 워크플로우
    ↓
Supabase buyers 테이블 자동 등록
    ↓
업무관리시스템에 표시
```

#### API 키 발급 방법
1. https://open.alibaba.com/ 접속
2. 판매자 계정으로 로그인
3. 앱 생성 → API 키 발급
4. 필요한 권한: Inquiry API, Trade API, Member API

#### n8n 워크플로우 구성
```
[Schedule Trigger: 5분마다]
    ↓
[HTTP Request: 알리바바 API - 새 문의 조회]
    ↓
[IF: 새 바이어인가?]
    ├─ Yes → [Supabase Insert: buyers 테이블]
    └─ No → [Supabase Update: 기존 바이어 정보 갱신]
    ↓
[업무관리시스템 자동 반영]
```

---

## 6. Supabase 테이블 구조 참고

### cs_data 테이블
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | 고유 ID |
| stage | text | 단계 (신규문의, 응대중, 견적발송, 협의중, 완료) |
| priority | text | 우선순위 (high, medium, low) |
| status | text | 상태 (pending, progress, completed) |
| type | text | 유형 (상품 문의, 배송 문의, 클레임 등) |
| title | text | 제목 |
| buyer | text | 바이어명 |
| buyer_level | text | 바이어 등급 (L0~L4) |
| assignee | text | 담당자 |
| date | date | 등록일 |
| content | text | 문의 내용 |
| reply | text | 답변 |

### buyers 테이블
| 필드 | 타입 | 설명 |
|------|------|------|
| id | int | 고유 ID |
| level | text | 등급 (L0~L4) |
| company | text | 회사명 |
| contact_name | text | 담당자명 |
| email | text | 이메일 |
| phone | text | 전화번호 |
| country | text | 국가 |
| sales_region | text[] | 판매 지역 |
| business_type | text | 사업 유형 |
| stage | text | 거래 단계 |
| status | text | 상태 |
| assignee | text | 담당자 |
| is_reorder | boolean | 재구매 여부 |

---

## 7. 파일 목록

| 파일명 | 설명 |
|--------|------|
| `업무관리시스템_통합_완성_공지_프로세스.html` | 메인 시스템 파일 |
| `cs관리,바이어관리 모달.html` | 참조용 모달 코드 (삽입자료_해외업무관리 폴더) |
| `운영관리_수정_4.html` | 참조용 상품/멀티유즈 코드 |

---

## 8. 다음 작업 예정

- [ ] 알리바바 API 키 발급
- [ ] 바이어 자동 등록 n8n 워크플로우 구성
- [ ] 주문 동기화 연동

---

## 문의
작업 중 문제 발생 시 이 파일과 함께 상황 설명하면 빠르게 해결 가능
